---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Mes Tickets">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900">Mes Tickets de Maintenance</h1>
      <p class="mt-2 text-gray-600">
        Consultez et gerez vos demandes de maintenance
      </p>
    </div>

    <div id="building-selector-container" class="mb-6"></div>

    <!-- Create Ticket Button -->
    <div class="mb-6">
      <button
        id="create-ticket-btn"
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
      >
        <svg
          class="-ml-1 mr-2 h-5 w-5"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            clip-rule="evenodd"></path>
        </svg>
        Creer un ticket
      </button>
    </div>

    <!-- My Tickets List -->
    <div id="my-tickets-list"></div>

    <!-- Create Ticket Modal Placeholder -->
    <div id="create-ticket-modal"></div>
  </div>
</Layout>

<script>
  import { mount, unmount } from "svelte";
  import TicketList from "../../components/tickets/TicketList.svelte";
  import TicketCreateModal from "../../components/tickets/TicketCreateModal.svelte";
  import BuildingSelector from "../../components/BuildingSelector.svelte";
  import { authStore } from "../../stores/auth";
  import { get } from "svelte/store";

  const auth = get(authStore);
  const userId = auth.user?.id || "";
  let currentBuildingId = "";

  function showPageToast(message: string, type: "success" | "error" | "warning" = "info") {
    const colors = { success: "bg-green-600", error: "bg-red-600", warning: "bg-yellow-500", info: "bg-blue-600" };
    const el = document.createElement("div");
    el.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white text-sm ${colors[type]}`;
    el.textContent = message;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3500);
  }
  let listComponent: any = null;

  const selectorContainer = document.getElementById("building-selector-container");
  const listContainer = document.getElementById("my-tickets-list");
  const modalContainer = document.getElementById("create-ticket-modal");
  let createModal: any = null;

  function mountList(buildingId: string) {
    currentBuildingId = buildingId;
    if (!listContainer) return;
    if (listComponent) {
      try { unmount(listComponent); } catch {}
    }
    listContainer.innerHTML = "";
    listComponent = mount(TicketList, {
      target: listContainer,
      props: { view: "my", buildingId },
    });
  }

  if (selectorContainer) {
    mount(BuildingSelector, {
      target: selectorContainer,
      props: {
        label: "Immeuble",
        onSelect: (id: string) => mountList(id),
      },
    });
  }

  function closeModal() {
    if (createModal) {
      try { unmount(createModal); } catch {}
      createModal = null;
      if (modalContainer) modalContainer.innerHTML = "";
    }
  }

  document
    .getElementById("create-ticket-btn")
    ?.addEventListener("click", () => {
      if (!currentBuildingId) {
        showPageToast("Veuillez d'abord sÃ©lectionner un immeuble.", "warning");
        return;
      }

      closeModal();
      if (modalContainer) {
        createModal = mount(TicketCreateModal, {
          target: modalContainer,
          props: {
            open: true,
            buildingId: currentBuildingId,
            requesterId: userId,
            onClose: closeModal,
            onCreated: () => {
              closeModal();
              mountList(currentBuildingId);
            },
          },
        });
      }
    });
</script>
