---
import Layout from "../layouts/Layout.astro";
---

<Layout title="DÃ©tail de la convocation - KoproGo">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-6">
      <a
        href="/convocations"
        class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700"
      >
        <svg class="mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Retour aux convocations
      </a>
    </div>

    <div id="convocation-detail"></div>

    <div id="loading-state" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      <p class="mt-4 text-gray-600">Chargement de la convocation...</p>
    </div>

    <div id="error-state" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
      <h2 class="text-lg font-semibold text-red-900 mb-2">Erreur</h2>
      <p class="text-red-700" id="error-message"></p>
      <a href="/convocations" class="mt-4 inline-block px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
        Retour aux convocations
      </a>
    </div>
  </div>
</Layout>

<script>
  import { mount } from "svelte";
  import ConvocationDetailView from "../components/convocations/ConvocationDetailView.svelte";
  import { convocationsApi } from "../lib/api/convocations";

  async function loadConvocation() {
    const params = new URLSearchParams(window.location.search);
    const convocationId = params.get("id");

    if (!convocationId) {
      showError("Aucun ID de convocation fourni");
      return;
    }

    try {
      const loadingEl = document.getElementById("loading-state");
      const detailContainer = document.getElementById("convocation-detail");
      if (!detailContainer) return;

      const convocation = await convocationsApi.getById(convocationId);

      if (loadingEl) loadingEl.style.display = "none";

      mount(ConvocationDetailView, {
        target: detailContainer,
        props: { convocation },
      });
    } catch (err: any) {
      showError(err.message || "Impossible de charger la convocation");
    }
  }

  function showError(message: string) {
    const loadingEl = document.getElementById("loading-state");
    const errorEl = document.getElementById("error-state");
    const errorMessageEl = document.getElementById("error-message");

    if (loadingEl) loadingEl.style.display = "none";
    if (errorEl) {
      errorEl.classList.remove("hidden");
      if (errorMessageEl) errorMessageEl.textContent = message;
    }
  }

  loadConvocation();
</script>
