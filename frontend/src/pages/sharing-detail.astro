---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Object Detail - KoproGo">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-6">
      <a
        href="/sharing"
        class="text-blue-600 hover:text-blue-800 flex items-center gap-1"
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"
          />
        </svg>
        Back to Object Sharing
      </a>
    </div>

    <div id="object-detail-container"></div>
  </div>
</Layout>

<script>
  import { mount } from "svelte";
  import { sharingApi, type SharedObject } from "../lib/api/sharing";
  import ObjectCategoryBadge from "../components/sharing/ObjectCategoryBadge.svelte";
  import ObjectConditionBadge from "../components/sharing/ObjectConditionBadge.svelte";
  import AvailabilityStatusBadge from "../components/sharing/AvailabilityStatusBadge.svelte";

  const urlParams = new URLSearchParams(window.location.search);
  const objectId = urlParams.get("id");

  if (!objectId) {
    window.location.href = "/sharing";
  } else {
    // Simplified detail page - just fetch and display the object
    sharingApi.getObjectById(objectId).then((object) => {
      const container = document.getElementById("object-detail-container");
      if (!container) return;

      container.innerHTML = `
        <div class="bg-white shadow rounded-lg overflow-hidden">
          ${object.image_urls && object.image_urls.length > 0 ? `
            <img src="${object.image_urls[0]}" alt="${object.object_name}" class="w-full h-64 object-cover" />
          ` : `
            <div class="w-full h-64 bg-gray-200 flex items-center justify-center">
              <span class="text-6xl text-gray-400">üì¶</span>
            </div>
          `}
          <div class="p-6">
            <div id="badges" class="flex items-center gap-2 mb-4"></div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">${object.object_name}</h1>
            ${object.owner_name ? `<p class="text-gray-600 mb-4">Owned by ${object.owner_name}</p>` : ''}
            <div class="prose max-w-none mb-6">
              <p class="text-gray-700">${object.description}</p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 bg-gray-50 rounded-lg p-4">
              <div>
                <p class="text-sm text-gray-600">Loan Duration</p>
                <p class="text-lg font-semibold text-gray-900">${object.loan_duration_days} days</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">Deposit</p>
                <p class="text-lg font-semibold text-gray-900">${object.deposit_required_cents ? `‚Ç¨${(object.deposit_required_cents / 100).toFixed(2)}` : 'None'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">Rating</p>
                <p class="text-lg font-semibold text-gray-900">${object.rating ? `‚≠ê ${object.rating.toFixed(1)}/5` : 'No ratings'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">Total Loans</p>
                <p class="text-lg font-semibold text-gray-900">${object.total_loans}</p>
              </div>
            </div>
            ${object.usage_instructions ? `
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h3 class="text-sm font-semibold text-blue-900 mb-1">Usage Instructions</h3>
                <p class="text-sm text-blue-700">${object.usage_instructions}</p>
              </div>
            ` : ''}
            ${object.replacement_value_cents ? `
              <p class="text-sm text-gray-600 mb-4">Replacement value: ‚Ç¨${(object.replacement_value_cents / 100).toFixed(2)}</p>
            ` : ''}
            ${object.availability_status === 'Available' ? `
              <button
                class="w-full bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                onclick="alert('Loan request feature coming soon!')"
              >
                Request to Borrow
              </button>
            ` : `
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                <p class="text-yellow-800">This object is currently unavailable</p>
              </div>
            `}
          </div>
        </div>
      `;

      // Mount badges
      const badgesContainer = document.getElementById("badges");
      if (badgesContainer) {
        mount(ObjectCategoryBadge, {
          target: badgesContainer,
          props: { category: object.object_category },
        });
        mount(ObjectConditionBadge, {
          target: badgesContainer,
          props: { condition: object.condition },
        });
        mount(AvailabilityStatusBadge, {
          target: badgesContainer,
          props: { status: object.availability_status },
        });
      }
    }).catch((err) => {
      const container = document.getElementById("object-detail-container");
      if (container) {
        container.innerHTML = `<div class="bg-white shadow rounded-lg p-12 text-center text-gray-500">Object not found</div>`;
      }
    });
  }
</script>
