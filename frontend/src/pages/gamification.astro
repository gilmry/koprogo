---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Gamification - KoproGo">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900">
        Gamification
      </h1>
      <p class="text-gray-600 mt-2">
        Gagnez des achievements, relevez des challenges et grimpez dans le classement de votre copropriété.
      </p>
    </div>

    <div id="building-selector-container" class="mb-6"></div>

    <!-- Main grid: achievements + sidebar -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Achievements (2/3) -->
      <div class="lg:col-span-2 space-y-6">
        <div id="achievement-list"></div>
        <div id="challenge-list"></div>
      </div>

      <!-- Sidebar (1/3) -->
      <div class="space-y-6">
        <div id="gamification-leaderboard"></div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { mount, unmount } from "svelte";
  import AchievementList from "../components/gamification/AchievementList.svelte";
  import ChallengeList from "../components/gamification/ChallengeList.svelte";
  import GamificationLeaderboard from "../components/gamification/GamificationLeaderboard.svelte";
  import BuildingSelector from "../components/BuildingSelector.svelte";

  const selectorContainer = document.getElementById("building-selector-container");
  const achContainer = document.getElementById("achievement-list");
  const chalContainer = document.getElementById("challenge-list");
  const lbContainer = document.getElementById("gamification-leaderboard");

  let achComponent: any = null;
  let chalComponent: any = null;
  let lbComponent: any = null;

  function mountComponents(buildingId: string, organizationId: string) {
    // Unmount previous instances
    if (achComponent) { try { unmount(achComponent); } catch {} }
    if (chalComponent) { try { unmount(chalComponent); } catch {} }
    if (lbComponent) { try { unmount(lbComponent); } catch {} }

    if (achContainer) {
      achContainer.innerHTML = "";
      achComponent = mount(AchievementList, {
        target: achContainer,
        props: { organizationId },
      });
    }

    if (chalContainer) {
      chalContainer.innerHTML = "";
      chalComponent = mount(ChallengeList, {
        target: chalContainer,
        props: { buildingId, organizationId },
      });
    }

    if (lbContainer) {
      lbContainer.innerHTML = "";
      lbComponent = mount(GamificationLeaderboard, {
        target: lbContainer,
        props: { organizationId, buildingId },
      });
    }
  }

  if (selectorContainer) {
    mount(BuildingSelector, {
      target: selectorContainer,
      props: {
        label: "Immeuble",
        onSelectBuilding: (building: any) => {
          mountComponents(building.id, building.organization_id || "");
        },
      },
    });
  }
</script>
