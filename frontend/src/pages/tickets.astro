---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Tickets - Maintenance Requests">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900">Maintenance Tickets</h1>
      <p class="mt-2 text-gray-600">
        Manage maintenance requests and track resolutions
      </p>
    </div>

    <!-- Statistics Widget -->
    <div class="mb-6">
      <div id="ticket-statistics"></div>
    </div>

    <!-- Create Ticket Button -->
    <div class="mb-6">
      <button
        id="create-ticket-btn"
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
      >
        <svg
          class="-ml-1 mr-2 h-5 w-5"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            clip-rule="evenodd"></path>
        </svg>
        Create New Ticket
      </button>
    </div>

    <!-- Tickets List -->
    <div id="tickets-list"></div>

    <!-- Create Ticket Modal Placeholder -->
    <div id="create-ticket-modal"></div>
  </div>
</Layout>

<script>
  import { mount, unmount } from "svelte";
  import TicketList from "../components/tickets/TicketList.svelte";
  import TicketStatistics from "../components/tickets/TicketStatistics.svelte";
  import TicketCreateModal from "../components/tickets/TicketCreateModal.svelte";

  function showPageToast(message: string, type: "success" | "error" | "warning" = "info") {
    const colors = { success: "bg-green-600", error: "bg-red-600", warning: "bg-yellow-500", info: "bg-blue-600" };
    const el = document.createElement("div");
    el.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white text-sm ${colors[type]}`;
    el.textContent = message;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3500);
  }

  // Mount statistics widget
  const statsContainer = document.getElementById("ticket-statistics");
  if (statsContainer) {
    mount(TicketStatistics, { target: statsContainer });
  }

  // Mount tickets list
  const listContainer = document.getElementById("tickets-list");
  if (listContainer) {
    mount(TicketList, {
      target: listContainer,
      props: {
        view: "all",
      },
    });

    const modalContainer = document.getElementById("create-ticket-modal");
    let createModal: any = null;

    function closeModal() {
      if (createModal) {
        try { unmount(createModal); } catch {}
        createModal = null;
        if (modalContainer) modalContainer.innerHTML = "";
      }
    }

    // Handle create button click
    document
      .getElementById("create-ticket-btn")
      ?.addEventListener("click", () => {
        const buildingId = new URLSearchParams(window.location.search).get(
          "building_id",
        );
        const userId = localStorage.getItem("koprogo_user_id") || "";

        if (!buildingId) {
          showPageToast("Veuillez d'abord sÃ©lectionner un immeuble.", "warning");
          return;
        }

        closeModal();
        if (modalContainer) {
          createModal = mount(TicketCreateModal, {
            target: modalContainer,
            props: {
              open: true,
              buildingId: buildingId,
              requesterId: userId,
              onClose: closeModal,
              onCreated: () => {
                window.location.reload();
              },
            },
          });
        }
      });
  }
</script>
