#!/bin/bash

# Script d'orchestration compl√®te pour setup infrastructure OVH
# Guide l'utilisateur pas √† pas pour:
# 1. Cr√©er les credentials OVH API
# 2. Cr√©er/configurer le projet Public Cloud
# 3. Cr√©er l'utilisateur OpenStack avec les bons r√¥les
# 4. T√©l√©charger le fichier OpenRC
# 5. Configurer le .env
# 6. Optionnel: Configurer un domaine et DNS
# 7. D√©ployer avec Terraform + Ansible

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TERRAFORM_DIR="$SCRIPT_DIR/terraform"
ANSIBLE_DIR="$SCRIPT_DIR/ansible"

# Couleurs
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë     KoproGo - Setup Infrastructure OVH Cloud               ‚ïë"
echo "‚ïë     Guide pas √† pas pour d√©ploiement complet               ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# ============================================================================
# V√©rifications pr√©alables
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 0: V√©rifications pr√©alables                      ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

# V√©rifier Terraform
if ! command -v terraform &> /dev/null; then
    echo -e "${RED}‚ùå Terraform n'est pas install√©${NC}"
    echo ""
    echo "Installation:"
    echo "  Ubuntu/Debian: wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg && echo \"deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main\" | sudo tee /etc/apt/sources.list.d/hashicorp.list && sudo apt update && sudo apt install terraform"
    echo "  macOS: brew install terraform"
    echo ""
    exit 1
fi

# V√©rifier Ansible
if ! command -v ansible &> /dev/null; then
    echo -e "${RED}‚ùå Ansible n'est pas install√©${NC}"
    echo ""
    echo "Installation:"
    echo "  Ubuntu/Debian: sudo apt install -y ansible"
    echo "  macOS: brew install ansible"
    echo "  pip: pip3 install ansible"
    echo ""
    exit 1
fi

echo -e "${GREEN}‚úÖ Terraform install√©: $(terraform version | head -n1)${NC}"
echo -e "${GREEN}‚úÖ Ansible install√©: $(ansible --version | head -n1)${NC}"
echo ""

# ============================================================================
# √âtape 1: Credentials OVH API
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 1: Configuration OVH API Credentials             ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

echo "Pour d√©ployer sur OVH, vous avez besoin de credentials API OVH."
echo ""
echo -e "${YELLOW}üìã Instructions:${NC}"
echo "  1. Ouvrez: https://www.ovh.com/auth/api/createToken"
echo "  2. Connectez-vous √† votre compte OVH"
echo "  3. Remplissez le formulaire:"
echo "     - Application name: KoproGo"
echo "     - Application description: KoproGo Infrastructure Management"
echo "     - Validity: Unlimited"
echo "     - Rights:"
echo "       GET    /cloud/*"
echo "       POST   /cloud/*"
echo "       PUT    /cloud/*"
echo "       DELETE /cloud/*"
echo "       GET    /domain/*"
echo "       POST   /domain/*"
echo "       PUT    /domain/*"
echo "  4. Cliquez sur 'Create keys'"
echo ""

read -p "Appuyez sur Entr√©e quand vous avez cr√©√© les credentials..."
echo ""

read -p "Application Key: " OVH_APPLICATION_KEY
read -p "Application Secret: " OVH_APPLICATION_SECRET
read -p "Consumer Key: " OVH_CONSUMER_KEY

echo ""
echo -e "${GREEN}‚úÖ Credentials OVH API enregistr√©es${NC}"
echo ""

# ============================================================================
# √âtape 2: Projet Public Cloud OVH
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 2: Projet Public Cloud OVH                       ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

echo "Vous avez besoin d'un projet Public Cloud OVH."
echo ""
echo -e "${YELLOW}üìã Instructions:${NC}"
echo "  1. Ouvrez: https://www.ovh.com/manager/public-cloud/"
echo "  2. Si vous n'avez pas de projet:"
echo "     - Cliquez sur 'Create a project'"
echo "     - Suivez les √©tapes de cr√©ation"
echo "  3. Notez le 'Project ID' (Service Name)"
echo "     - Visible dans: Project Management > Project ID"
echo "     - Format: 32 caract√®res (ex: dd8822a8a417499bb97651ed4728a2ca)"
echo ""

read -p "Appuyez sur Entr√©e quand vous √™tes pr√™t..."
echo ""

read -p "Project ID (Service Name): " OVH_SERVICE_NAME

echo ""
echo -e "${GREEN}‚úÖ Project ID enregistr√©: $OVH_SERVICE_NAME${NC}"
echo ""

# ============================================================================
# √âtape 3: Utilisateur OpenStack
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 3: Utilisateur OpenStack avec r√¥les appropri√©s   ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

echo "Vous devez cr√©er un utilisateur OpenStack avec les bons r√¥les."
echo ""
echo -e "${YELLOW}üìã Instructions:${NC}"
echo "  1. Ouvrez: https://www.ovh.com/manager/public-cloud/"
echo "  2. S√©lectionnez votre projet"
echo "  3. Allez dans: Project Management > Users & Roles"
echo "  4. Cliquez sur 'Create User'"
echo "  5. Description: koprogo-deploy"
echo "  6. Cochez TOUS les r√¥les suivants:"
echo ""
echo -e "${YELLOW}     ‚òë Administrator${NC} ${GREEN}(IMPORTANT!)${NC}"
echo "     ‚òë Compute Operator"
echo "     ‚òë Network Operator"
echo "     ‚òë Network Security Operator"
echo "     ‚òë Image Operator"
echo "     ‚òë Volume Operator"
echo "     ‚òë ObjectStore Operator"
echo "     ‚òë LoadBalancer Operator"
echo "     ‚òë Backup Operator"
echo "     ‚òë Infrastructure Supervisor"
echo "     ‚òë KeyManager Operator"
echo "     ‚òë KeyManager Read"
echo ""
echo "  7. Cliquez sur 'Confirm'"
echo "  8. IMPORTANT: Notez le mot de passe g√©n√©r√© (affich√© une seule fois!)"
echo "  9. Notez le nom d'utilisateur (format: user-XXXXXXXXXXXX)"
echo ""

read -p "Appuyez sur Entr√©e quand vous avez cr√©√© l'utilisateur..."
echo ""

read -p "Username OpenStack: " OS_USERNAME
read -s -p "Password OpenStack: " OS_PASSWORD
echo ""

echo ""
echo -e "${GREEN}‚úÖ Utilisateur OpenStack configur√©${NC}"
echo ""

# ============================================================================
# √âtape 4: Fichier OpenRC et R√©gion
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 4: T√©l√©chargement OpenRC et R√©gion               ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

echo "Le fichier OpenRC contient les informations de connexion OpenStack."
echo ""
echo -e "${YELLOW}üìã Instructions:${NC}"
echo "  1. Dans OVH Manager > Project Management > Users & Roles"
echo "  2. Cliquez sur le bouton '...' √† c√¥t√© de votre utilisateur"
echo "  3. S√©lectionnez 'Download OpenStack's RC file'"
echo "  4. Ouvrez le fichier t√©l√©charg√© et trouvez la ligne:"
echo "     export OS_REGION_NAME=\"GRAxx\""
echo "  5. Notez la r√©gion (ex: GRA9, GRA11, SBG5, etc.)"
echo ""

read -p "Appuyez sur Entr√©e quand vous avez le fichier OpenRC..."
echo ""

echo "R√©gions OVH disponibles:"
echo "  - GRA5, GRA7, GRA9, GRA11 (Gravelines, France)"
echo "  - SBG5, SBG7 (Strasbourg, France)"
echo "  - BHS5 (Beauharnois, Canada)"
echo "  - WAW1, WAW2 (Warsaw, Pologne)"
echo "  - UK1 (London, UK)"
echo "  - DE1 (Frankfurt, Allemagne)"
echo ""

read -p "R√©gion depuis le fichier OpenRC (ex: GRA9): " OS_REGION_NAME

echo ""
echo -e "${GREEN}‚úÖ R√©gion configur√©e: $OS_REGION_NAME${NC}"
echo ""

# ============================================================================
# √âtape 5: Configuration Domaine (Optionnel)
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 5: Configuration Domaine et DNS (Optionnel)      ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

echo "Voulez-vous configurer un domaine pour votre application?"
echo "Si oui, le DNS sera automatiquement configur√© pour pointer vers votre VPS."
echo ""

read -p "Configurer un domaine? (y/N): " CONFIGURE_DOMAIN

DOMAIN=""
ACME_EMAIL=""
CONFIGURE_DNS_AUTO="no"

if [[ "$CONFIGURE_DOMAIN" =~ ^[Yy]$ ]]; then
    echo ""
    read -p "Nom de domaine (ex: koprogo.example.com): " DOMAIN
    read -p "Email pour certificat SSL (Let's Encrypt): " ACME_EMAIL

    echo ""
    echo "Le domaine est-il g√©r√© chez OVH?"
    echo "(Si oui, le DNS sera configur√© automatiquement via l'API OVH)"
    read -p "Domaine g√©r√© chez OVH? (y/N): " OVH_DOMAIN

    if [[ "$OVH_DOMAIN" =~ ^[Yy]$ ]]; then
        CONFIGURE_DNS_AUTO="yes"
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  Le DNS sera configur√© automatiquement apr√®s le d√©ploiement${NC}"
    else
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  Vous devrez configurer manuellement le DNS:${NC}"
        echo "  1. Cr√©ez un enregistrement A pour $DOMAIN"
        echo "  2. Pointez-le vers l'IP du VPS (affich√©e apr√®s le d√©ploiement)"
    fi

    echo ""
    echo -e "${GREEN}‚úÖ Domaine configur√©: $DOMAIN${NC}"
fi

echo ""

# ============================================================================
# √âtape 6: G√©n√©ration fichier .env
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 6: G√©n√©ration du fichier de configuration        ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

echo "G√©n√©ration du fichier .env avec toutes les configurations..."
echo ""

cat > "$TERRAFORM_DIR/.env" <<EOF
# OVH Terraform Credentials
# Generated by setup-infra.sh on $(date)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# OVH API Credentials (for OVH provider)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

# OVH API Endpoint
OVH_ENDPOINT=ovh-eu

# OVH API Credentials
OVH_APPLICATION_KEY=$OVH_APPLICATION_KEY
OVH_APPLICATION_SECRET=$OVH_APPLICATION_SECRET
OVH_CONSUMER_KEY=$OVH_CONSUMER_KEY

# OVH Cloud Project ID
OVH_SERVICE_NAME=$OVH_SERVICE_NAME

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# OpenStack Credentials (for OpenStack provider - REQUIRED)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

# OpenStack Auth URL
OS_AUTH_URL=https://auth.cloud.ovh.net/v3
OS_IDENTITY_API_VERSION=3
OS_USER_DOMAIN_NAME=Default
OS_PROJECT_DOMAIN_NAME=Default

# OpenStack Project (from OpenRC file)
OS_PROJECT_ID=$OVH_SERVICE_NAME
OS_TENANT_ID=$OVH_SERVICE_NAME
OS_TENANT_NAME=$(echo $OVH_SERVICE_NAME | cut -c1-16)

# OpenStack User Credentials
OS_USERNAME=$OS_USERNAME
OS_PASSWORD=$OS_PASSWORD

# Region (from OpenRC file)
OS_REGION_NAME=$OS_REGION_NAME

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Domain Configuration (Optional)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

KOPROGO_DOMAIN=$DOMAIN
ACME_EMAIL=$ACME_EMAIL
CONFIGURE_DNS_AUTO=$CONFIGURE_DNS_AUTO
EOF

echo -e "${GREEN}‚úÖ Fichier .env cr√©√©: $TERRAFORM_DIR/.env${NC}"
echo ""

# Mettre √† jour terraform.tfvars
echo "Mise √† jour de terraform.tfvars..."

cat > "$TERRAFORM_DIR/terraform.tfvars" <<EOF
# Configuration OVH KoproGo
# Generated by setup-infra.sh on $(date)

ovh_service_name    = "$OVH_SERVICE_NAME"
instance_name       = "koprogo-production"
region              = "$OS_REGION_NAME"
ssh_public_key_path = "~/.ssh/id_rsa.pub"
EOF

echo -e "${GREEN}‚úÖ Fichier terraform.tfvars cr√©√©${NC}"
echo ""

# ============================================================================
# √âtape 7: R√©sum√© et confirmation
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 7: R√©sum√© de la configuration                    ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

echo "Configuration compl√®te:"
echo ""
echo "  ${YELLOW}OVH API:${NC}"
echo "    Application Key: ${OVH_APPLICATION_KEY:0:8}***"
echo "    Consumer Key: ${OVH_CONSUMER_KEY:0:8}***"
echo "    Project ID: $OVH_SERVICE_NAME"
echo ""
echo "  ${YELLOW}OpenStack:${NC}"
echo "    Username: $OS_USERNAME"
echo "    Region: $OS_REGION_NAME"
echo ""

if [ -n "$DOMAIN" ]; then
    echo "  ${YELLOW}Domaine:${NC}"
    echo "    Domain: $DOMAIN"
    echo "    Email SSL: $ACME_EMAIL"
    echo "    DNS Auto: $CONFIGURE_DNS_AUTO"
    echo ""
fi

echo "  ${YELLOW}Infrastructure:${NC}"
echo "    Instance: koprogo-production"
echo "    Type: d2-2 (2 vCPU, 4GB RAM)"
echo "    OS: Ubuntu 22.04"
echo ""

read -p "Confirmer et lancer le d√©ploiement? (y/N): " CONFIRM

if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo ""
    echo -e "${YELLOW}‚ùå D√©ploiement annul√©${NC}"
    echo ""
    echo "Configuration sauvegard√©e dans:"
    echo "  - $TERRAFORM_DIR/.env"
    echo "  - $TERRAFORM_DIR/terraform.tfvars"
    echo ""
    echo "Pour d√©ployer plus tard:"
    echo "  cd infrastructure/terraform"
    echo "  source ./load-env.sh"
    echo "  terraform init"
    echo "  terraform apply"
    exit 0
fi

echo ""

# ============================================================================
# √âtape 8: D√©ploiement Terraform
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 8: D√©ploiement Infrastructure (Terraform)        ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

cd "$TERRAFORM_DIR"

# Charger les variables d'environnement
echo "Chargement des variables d'environnement..."
set -a
source .env
set +a

# Initialiser Terraform si n√©cessaire
if [ ! -d ".terraform" ]; then
    echo "Initialisation Terraform..."
    terraform init
fi

echo ""
echo "D√©ploiement de l'infrastructure avec Terraform..."
echo ""

terraform apply -auto-approve

# R√©cup√©rer l'IP du VPS
VPS_IP=$(terraform output -raw vps_ip)

echo ""
echo -e "${GREEN}‚úÖ Infrastructure d√©ploy√©e avec succ√®s!${NC}"
echo -e "${GREEN}   VPS IP: $VPS_IP${NC}"
echo ""

# ============================================================================
# √âtape 9: Configuration DNS (si demand√©)
# ============================================================================

if [ "$CONFIGURE_DNS_AUTO" = "yes" ] && [ -n "$DOMAIN" ]; then
    echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${BLUE}‚îÇ √âtape 9: Configuration DNS automatique                 ‚îÇ${NC}"
    echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
    echo ""

    echo "Configuration du DNS pour $DOMAIN -> $VPS_IP"

    # Cr√©er un script Python pour configurer le DNS via l'API OVH
    cat > /tmp/configure-dns.py <<'PYEOF'
#!/usr/bin/env python3
import ovh
import sys
import os

domain = os.environ.get('DOMAIN')
vps_ip = os.environ.get('VPS_IP')

# Extract zone and subdomain
if '.' in domain:
    parts = domain.split('.')
    if len(parts) > 2:
        subdomain = parts[0]
        zone = '.'.join(parts[1:])
    else:
        subdomain = ''
        zone = domain
else:
    print("Invalid domain format")
    sys.exit(1)

client = ovh.Client(
    endpoint='ovh-eu',
    application_key=os.environ['OVH_APPLICATION_KEY'],
    application_secret=os.environ['OVH_APPLICATION_SECRET'],
    consumer_key=os.environ['OVH_CONSUMER_KEY'],
)

print(f"Configuring DNS: {domain} -> {vps_ip}")
print(f"  Zone: {zone}")
print(f"  Subdomain: {subdomain or '@'}")

try:
    # Check if record exists
    records = client.get(f'/domain/zone/{zone}/record',
                        fieldType='A',
                        subDomain=subdomain or None)

    if records:
        # Update existing record
        record_id = records[0]
        client.put(f'/domain/zone/{zone}/record/{record_id}',
                  target=vps_ip)
        print(f"‚úÖ Updated existing A record (ID: {record_id})")
    else:
        # Create new record
        client.post(f'/domain/zone/{zone}/record',
                   fieldType='A',
                   subDomain=subdomain,
                   target=vps_ip,
                   ttl=60)
        print(f"‚úÖ Created new A record")

    # Refresh zone
    client.post(f'/domain/zone/{zone}/refresh')
    print(f"‚úÖ DNS zone refreshed")

except Exception as e:
    print(f"‚ùå Error: {e}")
    sys.exit(1)
PYEOF

    chmod +x /tmp/configure-dns.py

    # Installer python3-ovh si n√©cessaire
    if ! python3 -c "import ovh" 2>/dev/null; then
        echo "Installation du module Python OVH..."
        pip3 install ovh 2>/dev/null || sudo pip3 install ovh
    fi

    # Ex√©cuter la configuration DNS
    export DOMAIN="$DOMAIN"
    export VPS_IP="$VPS_IP"

    if python3 /tmp/configure-dns.py; then
        echo ""
        echo -e "${GREEN}‚úÖ DNS configur√© automatiquement${NC}"
        echo ""
        echo "Propagation DNS:"
        echo "  - Peut prendre 1-60 minutes"
        echo "  - V√©rifier: dig $DOMAIN"
        echo ""
    else
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  √âchec configuration DNS automatique${NC}"
        echo ""
        echo "Configuration manuelle requise:"
        echo "  1. Connectez-vous √† votre gestionnaire DNS OVH"
        echo "  2. Cr√©ez un enregistrement A pour: $DOMAIN"
        echo "  3. Pointez vers: $VPS_IP"
        echo "  4. TTL: 60 seconds (ou minimum disponible)"
        echo ""
    fi

    rm -f /tmp/configure-dns.py
fi

# ============================================================================
# √âtape 10: Configuration Ansible
# ============================================================================

echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${BLUE}‚îÇ √âtape 10: Configuration et D√©ploiement Application     ‚îÇ${NC}"
echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""

cd "$ANSIBLE_DIR"

echo "Configuration de l'inventaire Ansible..."

# Cr√©er l'inventaire avec ou sans domaine
cat > inventory.ini <<EOF
# Ansible Inventory for KoproGo
# Generated by setup-infra.sh on $(date)
# VPS IP: $VPS_IP

[koprogo]
koprogo-vps ansible_host=$VPS_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa

[koprogo:vars]
# Domain configuration
EOF

if [ -n "$DOMAIN" ]; then
    echo "domain=$DOMAIN" >> inventory.ini
    echo "acme_email=$ACME_EMAIL" >> inventory.ini
fi

echo ""
echo -e "${GREEN}‚úÖ Inventaire Ansible cr√©√©${NC}"
echo ""

echo "Test de connexion SSH..."
if ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ubuntu@$VPS_IP "echo 'OK'" &>/dev/null; then
    echo -e "${GREEN}‚úÖ Connexion SSH OK${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Connexion SSH en attente...${NC}"
    echo "   Le VPS peut prendre 1-2 minutes √† d√©marrer compl√®tement"
    echo "   Attente de 60 secondes..."
    sleep 60

    if ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ubuntu@$VPS_IP "echo 'OK'" &>/dev/null; then
        echo -e "${GREEN}‚úÖ Connexion SSH OK${NC}"
    else
        echo -e "${RED}‚ùå Impossible de se connecter au VPS${NC}"
        echo ""
        echo "V√©rifiez:"
        echo "  1. Le VPS est d√©marr√© (OVH Manager > Public Cloud > Instances)"
        echo "  2. Votre cl√© SSH est correcte (~/.ssh/id_rsa.pub)"
        echo "  3. Test manuel: ssh ubuntu@$VPS_IP"
        echo ""
        echo "Pour d√©ployer plus tard:"
        echo "  cd infrastructure/ansible"
        echo "  ansible-playbook -i inventory.ini playbook.yml"
        exit 1
    fi
fi

echo ""
echo "D√©ploiement de l'application avec Ansible..."
echo "(Cela peut prendre 10-20 minutes)"
echo ""

# Exporter les variables pour Ansible
export KOPROGO_DOMAIN="$DOMAIN"
export ACME_EMAIL="$ACME_EMAIL"

ansible-playbook -i inventory.ini playbook.yml

echo ""

# ============================================================================
# R√©sum√© final
# ============================================================================

echo ""
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë              üéâ D√©ploiement Termin√©! üéâ                    ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

if [ -n "$DOMAIN" ]; then
    echo -e "${GREEN}üåê Application disponible:${NC}"
    echo "   https://$DOMAIN/api/v1"
    echo "   https://$DOMAIN/api/v1/health"
else
    echo -e "${GREEN}üåê Application disponible:${NC}"
    echo "   http://$VPS_IP:8080/api/v1"
    echo "   http://$VPS_IP:8080/api/v1/health"
fi

echo ""
echo -e "${YELLOW}üìä Informations utiles:${NC}"
echo "   IP du VPS: $VPS_IP"
echo "   SSH: ssh ubuntu@$VPS_IP"
echo "   Logs: ssh ubuntu@$VPS_IP 'cd /home/koprogo/koprogo && docker compose logs -f'"
echo ""
echo -e "${YELLOW}üîÑ Maintenance:${NC}"
echo "   Auto-update: Tous les jours √† 3h (cron)"
echo "   Backups: Tous les jours √† 2h (cron)"
echo "   Health checks: Toutes les 5 minutes (cron)"
echo ""
echo -e "${YELLOW}üìö Documentation:${NC}"
echo "   infrastructure/terraform/README.md"
echo "   infrastructure/ansible/README.md"
echo ""

if [ "$CONFIGURE_DNS_AUTO" = "yes" ] && [ -n "$DOMAIN" ]; then
    echo -e "${YELLOW}‚è≥ Note DNS:${NC}"
    echo "   La propagation DNS peut prendre 1-60 minutes"
    echo "   V√©rifier: dig $DOMAIN"
    echo ""
fi

echo -e "${GREEN}‚úÖ Setup infrastructure termin√© avec succ√®s!${NC}"
echo ""
