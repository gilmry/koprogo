#!/bin/bash

# Script pour crÃ©er automatiquement inventory.ini depuis Terraform outputs
# Usage: ./setup-inventory.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TERRAFORM_DIR="$SCRIPT_DIR/../terraform"
INVENTORY_FILE="$SCRIPT_DIR/inventory.ini"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Configuration Ansible Inventory depuis Terraform"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# VÃ©rifier que Terraform a dÃ©ployÃ©
if [ ! -d "$TERRAFORM_DIR/.terraform" ]; then
    echo "âŒ Terraform n'est pas initialisÃ© dans $TERRAFORM_DIR"
    echo "   ExÃ©cutez d'abord: cd $TERRAFORM_DIR && terraform init"
    exit 1
fi

# VÃ©rifier qu'il y a un dÃ©ploiement
if [ ! -f "$TERRAFORM_DIR/terraform.tfstate" ]; then
    echo "âŒ Aucun dÃ©ploiement Terraform trouvÃ©"
    echo "   ExÃ©cutez d'abord: cd $TERRAFORM_DIR && terraform apply"
    exit 1
fi

# RÃ©cupÃ©rer l'IP du VPS depuis Terraform
echo "ğŸ“¡ RÃ©cupÃ©ration de l'IP du VPS depuis Terraform..."
cd "$TERRAFORM_DIR"

# Charger les variables d'environnement si nÃ©cessaire
if [ -f .env ]; then
    set -a
    source .env
    set +a
fi

VPS_IP=$(terraform output -raw vps_ip 2>/dev/null)

if [ -z "$VPS_IP" ] || [ "$VPS_IP" == "null" ]; then
    echo "âŒ Impossible de rÃ©cupÃ©rer l'IP du VPS"
    echo "   VÃ©rifiez que terraform apply a Ã©tÃ© exÃ©cutÃ© avec succÃ¨s"
    exit 1
fi

echo "âœ… VPS IP trouvÃ©e: $VPS_IP"
echo ""

# Demander des variables optionnelles
echo "Configuration optionnelle:"
echo ""
read -p "Domaine (optionnel, laissez vide pour skip): " DOMAIN
read -p "Email ACME pour SSL (optionnel, laissez vide pour skip): " ACME_EMAIL

# CrÃ©er inventory.ini
echo ""
echo "ğŸ“ CrÃ©ation de inventory.ini..."

cat > "$INVENTORY_FILE" <<EOF
# Ansible Inventory for KoproGo
# Generated by setup-inventory.sh on $(date)
# VPS IP from Terraform: $VPS_IP

[koprogo]
koprogo-vps ansible_host=$VPS_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa

[koprogo:vars]
# Domain configuration (optional)
EOF

if [ -n "$DOMAIN" ]; then
    echo "domain=$DOMAIN" >> "$INVENTORY_FILE"
fi

if [ -n "$ACME_EMAIL" ]; then
    echo "acme_email=$ACME_EMAIL" >> "$INVENTORY_FILE"
fi

echo "âœ… Fichier inventory.ini crÃ©Ã©"
echo ""

# Afficher le contenu
echo "Contenu de inventory.ini:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cat "$INVENTORY_FILE"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# VÃ©rifier Ansible
if ! command -v ansible &> /dev/null; then
    echo "âš ï¸  Ansible n'est pas installÃ©"
    echo ""
    echo "Pour installer Ansible:"
    echo "  Ubuntu/Debian: sudo apt install -y ansible"
    echo "  macOS: brew install ansible"
    echo "  pip: pip3 install ansible"
    echo ""
    exit 1
fi

echo "âœ… Ansible installÃ©: $(ansible --version | head -n1)"
echo ""

# Tester la connexion SSH
echo "ğŸ” Test de connexion SSH au VPS..."
if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ubuntu@$VPS_IP "echo 'OK'" &>/dev/null; then
    echo "âœ… Connexion SSH OK"
else
    echo "âš ï¸  Connexion SSH Ã©chouÃ©e"
    echo "   VÃ©rifiez que votre clÃ© SSH est configurÃ©e correctement"
    echo "   Test manuel: ssh ubuntu@$VPS_IP"
    echo ""
    echo "   Si c'est la premiÃ¨re connexion, ajoutez l'hÃ´te:"
    echo "   ssh-keyscan -H $VPS_IP >> ~/.ssh/known_hosts"
fi

echo ""

# Tester avec Ansible ping
echo "ğŸ” Test de connexion Ansible..."
cd "$SCRIPT_DIR"
if ansible koprogo -i inventory.ini -m ping &>/dev/null; then
    echo "âœ… Ansible ping OK"
else
    echo "âš ï¸  Ansible ping Ã©chouÃ©"
    echo "   Test manuel: ansible koprogo -i inventory.ini -m ping"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Configuration terminÃ©e!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Prochaines Ã©tapes:"
echo ""
echo "  1. Tester la connexion:"
echo "     ansible koprogo -i inventory.ini -m ping"
echo ""
echo "  2. DÃ©ployer KoproGo:"
echo "     ansible-playbook -i inventory.ini playbook.yml"
echo ""
echo "  3. VÃ©rifier l'API:"
echo "     curl http://$VPS_IP:8080/api/v1/health"
echo ""
